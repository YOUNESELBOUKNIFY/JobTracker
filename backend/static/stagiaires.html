<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Stagiaires Job Scraper</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #scrapingLoader { display: none; }
    #applied-offers tr:nth-child(even),
    #new-offers tr:nth-child(even) { background-color: #f9fafb; }
    #applied-offers tr:hover,
    #new-offers tr:hover { background-color: #e0f2fe; transition: background-color 0.2s; }
    button { transition: all 0.2s; }
    th.cursor-pointer { cursor: pointer; }
  </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

<header class="bg-purple-600 text-white shadow-md py-4">
  <div class="max-w-6xl mx-auto flex justify-between items-center px-4">
    <h1 class="text-2xl font-bold">Stagiaires Job Scraper</h1>
    <button id="scrapeBtn" class="bg-white text-purple-600 px-4 py-2 rounded hover:bg-gray-100">
      Scraper Stagiaires
    </button>
  </div>
  <div class="max-w-6xl mx-auto px-4 mt-2 flex items-center gap-2 text-indigo-200 font-semibold">
    <svg id="scrapingLoader" class="animate-spin h-5 w-5 text-indigo-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
    </svg>
    Scraping en cours...
  </div>
</header>

<main class="flex-grow max-w-6xl mx-auto p-6">

  <div class="mb-6 flex justify-end items-center gap-2 text-green-700 font-semibold">
    <span>Total Offres enregistrées :</span>
    <span id="savedOffersCount" class="text-green-600 font-bold">0</span>
  </div>

  <h2 class="text-xl font-semibold mb-2">Offres enregistrées <span id="appliedOffersCount" class="text-green-600 font-bold">(0)</span></h2>
  <table class="table-auto w-full mb-6 bg-white shadow-lg rounded-lg overflow-hidden">
    <thead class="bg-green-200">
      <tr>
        <th class="p-3 uppercase text-left text-gray-700 font-medium">Titre</th>
        <th class="p-3 uppercase text-left text-gray-700 font-medium">Entreprise</th>
        <th class="p-3 uppercase text-left text-gray-700 font-medium">Localisation</th>
        <th class="p-3 uppercase text-left text-gray-700 font-medium">Lien</th>
        <th class="p-3 uppercase text-left text-gray-700 font-medium">Publié</th>
        <th class="p-3 uppercase text-left text-gray-700 font-medium">Statut</th>
        <th class="p-3 uppercase text-left text-gray-700 font-medium">Actions</th>
      </tr>
    </thead>
    <tbody id="applied-offers" class="divide-y divide-gray-200"></tbody>
  </table>

  <h2 class="text-xl font-semibold mb-2">Nouvelles offres <span id="newOffersCount" class="text-purple-600 font-bold">(0)</span></h2>
  <table class="table-auto w-full bg-white shadow-lg rounded-lg overflow-hidden">
    <thead class="bg-purple-200">
      <tr>
        <th class="p-3 uppercase text-left text-gray-700 font-medium">Titre</th>
        <th class="p-3 uppercase text-left text-gray-700 font-medium">Entreprise</th>
        <th class="p-3 uppercase text-left text-gray-700 font-medium">Localisation</th>
        <th class="p-3 uppercase text-left text-gray-700 font-medium">Lien</th>
        <th id="sortPublished" class="p-3 uppercase text-left text-gray-700 font-medium cursor-pointer">
          Publié <span id="sortIcon">⬍</span>
        </th>
        <th class="p-3 uppercase text-left text-gray-700 font-medium">Actions</th>
      </tr>
    </thead>
    <tbody id="new-offers" class="divide-y divide-gray-200"></tbody>
  </table>

</main>

<footer class="bg-gray-800 text-gray-200 py-4 mt-auto">
  <div class="max-w-6xl mx-auto text-center">
    &copy; 2025 Stagiaires Job Scraper - Tous droits réservés
  </div>
</footer>

<script>
const scrapeBtn = document.getElementById("scrapeBtn");
const scrapingLoader = document.getElementById("scrapingLoader");
const appliedTbody = document.getElementById("applied-offers");
const newTbody = document.getElementById("new-offers");
const savedCountEl = document.getElementById("savedOffersCount");
const appliedCountEl = document.getElementById("appliedOffersCount");
const newCountEl = document.getElementById("newOffersCount");

let newOffers = JSON.parse(sessionStorage.getItem("newOffers") || "[]");
let appliedIds = [];

// Extraire ID job
function extractJobId(url){
  if(!url) return null;
  const parts = url.split("/").filter(Boolean);
  return parts[parts.length-1];
}

function updateCounts(){
  appliedCountEl.textContent = `(${appliedTbody.querySelectorAll("tr").length})`;
  savedCountEl.textContent = appliedTbody.querySelectorAll("tr").length;
  newCountEl.textContent = `(${newTbody.querySelectorAll("tr").length})`;
}

// Charger offres enregistrées
async function loadAppliedJobs(){
  try{
    const res = await fetch("/jobs/applied/full");
    const data = await res.json();
    appliedTbody.innerHTML = "";
    appliedIds = data.map(j=>extractJobId(j.Lien)).filter(Boolean);

    data.forEach(job=>{
      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="p-2">${job.Titre||""}</td>
        <td class="p-2">${job.Entreprise||""}</td>
        <td class="p-2">${job.Localisation||""}</td>
        <td class="p-2"><a href="${job.Lien}" target="_blank" class="text-blue-600 underline">Voir</a></td>
        <td class="p-2">${job.Publié||""}</td>
        <td class="p-2">
          <select class="statusSelect px-2 py-1 border rounded">
            <option value="À postuler" ${job.Statut==='À postuler'?'selected':''}>À postuler</option>
            <option value="Postulé" ${job.Statut==='Postulé'?'selected':''}>Postulé</option>
            <option value="Entretien" ${job.Statut==='Entretien'?'selected':''}>Entretien</option>
            <option value="Refusé" ${job.Statut==='Refusé'?'selected':''}>Refusé</option>
          </select>
        </td>
        <td class="p-2">
          <button class="saveStatusBtn bg-purple-500 text-white px-2 py-1 rounded hover:bg-purple-600">Enregistrer</button>
        </td>
      `;
      appliedTbody.appendChild(row);
      row.querySelector(".saveStatusBtn").addEventListener("click",async()=>{
        const newStatus = row.querySelector(".statusSelect").value;
        await saveJobStatus({...job, Statut:newStatus});
        const idx = newOffers.findIndex(j=>extractJobId(j.Lien)===extractJobId(job.Lien));
        if(idx!==-1){ newOffers.splice(idx,1); sessionStorage.setItem("newOffers",JSON.stringify(newOffers)); displayNewOffers(); }
      });
    });
    updateCounts();
  }catch(err){ console.error(err); }
}

// Sauvegarder statut
async function saveJobStatus(job){
  await fetch("/jobs/status",{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(job)});
}

// Afficher nouvelles offres
function displayNewOffers(){
  newTbody.innerHTML="";
  newOffers.forEach((job,index)=>{
    const jobId = extractJobId(job.Lien);
    if(!jobId || appliedIds.includes(jobId)) return;
    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="p-2">${job.Titre||""}</td>
      <td class="p-2">${job.Entreprise||""}</td>
      <td class="p-2">${job.Localisation||""}</td>
      <td class="p-2"><a href="${job.Lien}" target="_blank" class="text-blue-600 underline">Voir</a></td>
      <td class="p-2">${job.Publié||""}</td>
      <td class="p-2">
        <button class="bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600">Enregistrer</button>
      </td>
    `;
    row.querySelector("button").addEventListener("click",async()=>{
      await saveJobStatus(job);
      newOffers.splice(index,1);
      sessionStorage.setItem("newOffers",JSON.stringify(newOffers));
      row.remove();
      updateCounts();
    });
    newTbody.appendChild(row);
  });
  updateCounts();
}

// Scraper Stagiaires
async function scrapeStagiaires(){
  scrapingLoader.style.display="flex";
  newOffers=[];
  sessionStorage.removeItem("newOffers");
  newTbody.innerHTML="";
  try{
    const res = await fetch("/scrape/stagiaires");
    const data = await res.json();
    newOffers = data.filter(j=>{ const id=extractJobId(j.Lien); return id && !appliedIds.includes(id);});
    sessionStorage.setItem("newOffers",JSON.stringify(newOffers));
    displayNewOffers();
  }catch(err){ console.error(err);}
  finally{ scrapingLoader.style.display="none"; }
}

// Tri par Publié
let publishedSortAsc = true;
function parseRelativeDays(text){
  text=text.toLowerCase();
  if(text.includes("jour")) return parseInt(text)||0;
  if(text.includes("semaine")) return (parseInt(text)||0)*7;
  if(text.includes("mois")) return (parseInt(text)||0)*30;
  return 0;
}
function sortNewOffersByPublished(){
  const rows = Array.from(newTbody.querySelectorAll("tr"));
  rows.sort((a,b)=>{
    const aDays = parseRelativeDays(a.cells[4].innerText);
    const bDays = parseRelativeDays(b.cells[4].innerText);
    return publishedSortAsc ? aDays-bDays : bDays-aDays;
  });
  newTbody.innerHTML="";
  rows.forEach(r=>newTbody.appendChild(r));
  publishedSortAsc = !publishedSortAsc;
}

document.getElementById("sortPublished").addEventListener("click",sortNewOffersByPublished);

// Init
window.onload = async()=>{
  await loadAppliedJobs();
  displayNewOffers();
};
scrapeBtn.addEventListener("click",scrapeStagiaires);
</script>

</body>
</html>
