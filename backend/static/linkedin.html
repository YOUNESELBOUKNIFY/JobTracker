<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Job Scraper - Younes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #scrapingLoader { display: none; }
    table tr:nth-child(even) { background-color: #f9fafb; }
    table tr:hover { background-color: #e0f2fe; transition: background-color 0.2s; }
    button { transition: all 0.2s; }
  </style>
</head>

<body class="bg-gray-100 flex flex-col min-h-screen">
<!-- ============== HEADER ============== -->
<header class="bg-blue-600 text-white shadow-md py-4">
  <div class="max-w-6xl mx-auto flex justify-between items-center px-4">
    <h1 class="text-2xl font-bold">üîé Job Scraper</h1>
    <button id="scrapeBtn" class="bg-white text-blue-600 px-4 py-2 rounded hover:bg-gray-100 font-semibold">
      Scraper LinkedIn
    </button>
  </div>
  <div id="scrapingLoader" class="max-w-6xl mx-auto px-4 mt-2 flex items-center gap-2 text-indigo-200 font-semibold">
    <svg class="animate-spin h-5 w-5 text-indigo-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
    </svg>
    Scraping en cours...
  </div>
</header>

<!-- ============== MAIN ============== -->
<main class="flex-grow max-w-6xl mx-auto p-6">
  <!-- Compteur -->
  <div class="mb-6 flex justify-end items-center gap-2 text-green-700 font-semibold">
    <span>Total Offres enregistr√©es :</span>
    <span id="savedOffersCount" class="text-green-600 font-bold">0</span>
  </div>

  <!-- Offres enregistr√©es -->
<section class="mb-10">
  <h2 class="text-xl font-semibold mb-2">Offres enregistr√©es 
    <span id="appliedOffersCount" class="text-green-600 font-bold">(0)</span>
  </h2>
  <table class="table-auto w-full bg-white shadow-lg rounded-lg overflow-hidden">
    <thead class="bg-green-200">
      <tr>
        <th class="p-3 text-left">Titre</th>
        <th class="p-3 text-left">Entreprise</th>
        <th class="p-3 text-left">Localisation</th>
        <th class="p-3 text-left">Lien</th>
        <th class="p-3 text-left">Statut</th>
      </tr>
    </thead>
    <tbody id="applied-offers" class="divide-y divide-gray-200"></tbody>
  </table>
</section>


  <!-- Nouvelles offres -->
  <section>
    <h2 class="text-xl font-semibold mb-2">Nouvelles offres 
      <span id="newOffersCount" class="text-blue-600 font-bold">(0)</span>
    </h2>
    <table class="table-auto w-full bg-white shadow-lg rounded-lg overflow-hidden">
      <thead class="bg-blue-200">
        <tr>
          <th class="p-3 text-left">Titre</th>
          <th class="p-3 text-left">Entreprise</th>
          <th class="p-3 text-left">Localisation</th>
          <th class="p-3 text-left">Lien</th>
          <th class="p-3 text-left">Publi√©</th>
          <th class="p-3 text-left">Actions</th>
        </tr>
      </thead>
      <tbody id="new-offers" class="divide-y divide-gray-200"></tbody>
    </table>
  </section>
</main>

<!-- ============== FOOTER ============== -->
<footer class="bg-gray-800 text-gray-200 py-4 mt-auto text-center">
  &copy; 2025 Job Scraper - <strong>Younes Elbouknify</strong>
</footer>

<script>
// ================= VARIABLES =================
const scrapeBtn = document.getElementById("scrapeBtn");
const scrapingLoader = document.getElementById("scrapingLoader");
const appliedTbody = document.getElementById("applied-offers");
const newTbody = document.getElementById("new-offers");
const savedCountEl = document.getElementById("savedOffersCount");
const appliedCountEl = document.getElementById("appliedOffersCount");
const newCountEl = document.getElementById("newOffersCount");

let newOffers = JSON.parse(sessionStorage.getItem("newOffers") || "[]");
let appliedIds = [];

// ================= FONCTIONS =================
const extractJobId = url => url?.split("?")[0].split("-").pop().match(/^\d+$/) ? url.split("-").pop() : null;

const updateCounts = () => {
  appliedCountEl.textContent = `(${appliedTbody.rows.length})`;
  savedCountEl.textContent = appliedTbody.rows.length;
  newCountEl.textContent = `(${newTbody.rows.length})`;
};

function getStatusColor(status) {
  switch (status) {
    case "Postul√©": return "text-blue-600 font-semibold";
    case "Entretien": return "text-green-600 font-semibold";
    case "Refus√©": return "text-red-600 font-semibold";
    default: return "text-gray-600";
  }
}

// Charger les offres enregistr√©es (sans actions)
// Liste des statuts possibles
const statusOptions = ["√Ä postuler", "Postul√©", "Entretien", "Accept√©", "Refus√©"];

// Charger les offres enregistr√©es avec statut modifiable
async function loadAppliedJobs() {
  try {
    const res = await fetch("/jobs/applied/full");
    const data = await res.json();
    appliedTbody.innerHTML = "";
    appliedIds = data.map(j => extractJobId(j.Lien)).filter(Boolean);

    data.forEach(job => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="p-2">${job.Titre}</td>
        <td class="p-2">${job.Entreprise}</td>
        <td class="p-2">${job.Localisation}</td>
        <td class="p-2"><a href="${job.Lien}" target="_blank" class="text-blue-600 underline">Voir</a></td>
        <td class="p-2">
          <select class="statusSelect px-2 py-1 border rounded">
            ${statusOptions.map(s => `<option value="${s}" ${job.Statut===s?'selected':''}>${s}</option>`).join('')}
          </select>
        </td>
      `;
      // Quand le statut change, on sauvegarde automatiquement
      row.querySelector(".statusSelect").addEventListener("change", async (e) => {
        const newStatus = e.target.value;
        await saveJobStatus({...job, Statut: newStatus});
      });
      appliedTbody.appendChild(row);
    });
    updateCounts();
  } catch (err) { console.error("Erreur chargement :", err); }
}


// Sauvegarder une nouvelle offre
async function saveJobStatus(job) {
  try {
    const res = await fetch("/jobs/status", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(job)
    });
    if (!res.ok) throw new Error(await res.text());
  } catch (err) { alert("Erreur : " + err.message); }
}

// Afficher les nouvelles offres
function displayNewOffers() {
  newTbody.innerHTML = "";
  newOffers
    .filter(j => !appliedIds.includes(extractJobId(j.Lien)))
    .forEach(job => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="p-2">${job.Titre}</td>
        <td class="p-2">${job.Entreprise}</td>
        <td class="p-2">${job.Localisation}</td>
        <td class="p-2"><a href="${job.Lien}" target="_blank" class="text-blue-600 underline">Voir</a></td>
        <td class="p-2">${job.Publi√©}</td>
        <td class="p-2 text-right">
          <button class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">Enregistrer</button>
        </td>
      `;
      row.querySelector("button").addEventListener("click", async () => {
        await saveJobStatus(job);
        row.remove();
        updateCounts();
      });
      newTbody.appendChild(row);
    });
  updateCounts();
}

// Scraper LinkedIn
async function scrapeLinkedin() {
  scrapingLoader.style.display = "flex";
  try {
    const res = await fetch("/scrape/linkedin");
    const data = await res.json();
    newOffers = data.filter(j => !appliedIds.includes(extractJobId(j.Lien)));
    sessionStorage.setItem("newOffers", JSON.stringify(newOffers));
    displayNewOffers();
  } catch (err) { console.error(err); }
  finally { scrapingLoader.style.display = "none"; }
}

// Initialisation
window.onload = async () => { await loadAppliedJobs(); displayNewOffers(); };
scrapeBtn.addEventListener("click", scrapeLinkedin);
</script>
</body>
</html>
