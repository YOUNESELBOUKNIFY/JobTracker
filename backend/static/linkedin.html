<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Jobs LinkedIn - Job Scraper</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Thème bleu-noir moderne */
    body {
      background: linear-gradient(180deg, #0a0f1f, #0f172a);
      color: #e2e8f0;
    }

    header {
      background: linear-gradient(90deg, #1e3a8a, #0f172a);
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }

    .job-card {
      background: #1e293b;
      border: 1px solid rgba(255,255,255,0.08);
      transition: transform 0.3s, box-shadow 0.3s, background 0.3s;
    }
    .job-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 25px rgba(0,0,0,0.4);
      background: #334155;
    }

    .pagination-btn {
      background: #1e3a8a;
      color: white;
      transition: all 0.3s;
    }
    .pagination-btn:hover {
      background: #2563eb;
    }
    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    footer {
      background: #0f172a;
      color: #94a3b8;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    a {
      color: #3b82f6;
    }
    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body class="flex flex-col min-h-screen font-sans">

<header class="text-white shadow-lg py-4">
  <div class="max-w-7xl mx-auto flex justify-between items-center px-4">
    <h1 class="text-2xl font-bold">Jobs LinkedIn</h1>

  </div>
  <div class="max-w-7xl mx-auto px-4 mt-2 text-indigo-200 font-semibold flex gap-2 items-center">
    <span>Prochaine session de scraping dans:</span>
    <span id="nextScrapeTimer" class="font-bold text-lg">--:--:--</span>
  </div>
</header>

<main class="flex-grow max-w-7xl mx-auto p-6">
  <section>
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-semibold text-gray-100">Toutes les offres LinkedIn</h2>
      <span id="totalJobs" class="text-gray-300 font-medium"></span>
    </div>

    <div id="jobsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>

    <div class="flex justify-center items-center gap-4 my-8">
      <button id="prevPage" class="pagination-btn px-4 py-2 rounded-lg shadow-sm">Précédent</button>
      <span class="text-gray-300 font-medium">Page <span id="currentPage">1</span> / <span id="totalPages">1</span></span>
      <button id="nextPage" class="pagination-btn px-4 py-2 rounded-lg shadow-sm">Suivant</button>
    </div>

    <p id="noJobsMsg" class="text-center text-gray-400 mt-6 hidden text-lg italic">Aucune offre disponible.</p>
  </section>
</main>

<footer class="py-6 mt-auto text-center shadow-inner">
  &copy; 2025 Job Scraper - <strong class="text-white">Younes Elbouknify</strong>
</footer>

<script>
const jobsContainer = document.getElementById("jobsContainer");
const prevPageBtn = document.getElementById("prevPage");
const nextPageBtn = document.getElementById("nextPage");
const currentPageSpan = document.getElementById("currentPage");
const totalPagesSpan = document.getElementById("totalPages");
const totalJobsSpan = document.getElementById("totalJobs");
const noJobsMsg = document.getElementById("noJobsMsg");
const clearDBBtn = document.getElementById("clearDBBtn");
const nextScrapeTimer = document.getElementById("nextScrapeTimer");

let allJobs = [];
let currentPage = 1;
const PAGE_SIZE = 8;
let nextScrapeTime = null;

// Charger tous les jobs depuis la table jobs_saved
async function loadJobs() {
  try {
    const res = await fetch("/jobs/saved");
    allJobs = await res.json();
    currentPage = 1;
    renderJobs();
  } catch(err) {
    console.error(err);
    allJobs = [];
    renderJobs();
  }
}

// Affichage des jobs avec pagination
function renderJobs() {
  if(allJobs.length === 0){
    jobsContainer.innerHTML = "";
    noJobsMsg.classList.remove("hidden");
    prevPageBtn.disabled = true;
    nextPageBtn.disabled = true;
    totalJobsSpan.textContent = "0 offres";
    currentPageSpan.textContent = 0;
    totalPagesSpan.textContent = 0;
    return;
  }

  noJobsMsg.classList.add("hidden");
  totalJobsSpan.textContent = `${allJobs.length} offres`;

  const totalPages = Math.ceil(allJobs.length / PAGE_SIZE);
  currentPage = Math.min(Math.max(currentPage,1), totalPages);

  currentPageSpan.textContent = currentPage;
  totalPagesSpan.textContent = totalPages;

  const start = (currentPage-1)*PAGE_SIZE;
  const end = start + PAGE_SIZE;
  const pageJobs = allJobs.slice(start,end);

  jobsContainer.innerHTML = "";
  pageJobs.forEach(job => {
    const card = document.createElement("div");
    card.className = "job-card rounded-lg p-4 flex flex-col justify-between";
    card.innerHTML = `
      <h3 class="font-bold text-lg text-gray-100 mb-2">${job.Titre}</h3>
      <p class="text-gray-300 mb-1"><strong>Entreprise:</strong> ${job.Entreprise}</p>
      <p class="text-gray-300 mb-1"><strong>Localisation:</strong> ${job.Localisation}</p>
      <p class="text-gray-400 mb-2"><strong>Publié:</strong> ${job.Publié || "N/A"}</p>
      <div class="flex justify-between mt-2 gap-2 flex-wrap">
        <a href="${job.Lien}" target="_blank" class="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 shadow transition-all">Voir l'offre</a>
      </div>
    `;
    jobsContainer.appendChild(card);
  });

  prevPageBtn.disabled = currentPage === 1;
  nextPageBtn.disabled = currentPage === totalPages;
}

// Pagination boutons
prevPageBtn.addEventListener("click",()=>{if(currentPage>1){currentPage--;renderJobs();}});
nextPageBtn.addEventListener("click",()=>{const totalPages=Math.ceil(allJobs.length/PAGE_SIZE);if(currentPage<totalPages){currentPage++;renderJobs();}});



// Countdown prochaine session
function startScrapeCountdown(){
  fetch("/sessions")
    .then(res=>res.json())
    .then(sessions=>{
      if(sessions.length===0) return;
      const lastSession=new Date(sessions[0].created_at);
      nextScrapeTime=new Date(lastSession.getTime()+4*3600*1000);
    })
    .catch(err=>console.error(err));

  setInterval(()=>{
    if(!nextScrapeTime) return;
    const now=new Date();
    const diff=Math.max(0,Math.floor((nextScrapeTime-now)/1000));
    const h=String(Math.floor(diff/3600)).padStart(2,"0");
    const m=String(Math.floor((diff%3600)/60)).padStart(2,"0");
    const s=String(diff%60).padStart(2,"0");
    nextScrapeTimer.textContent=`${h}:${m}:${s}`;
  },1000);
}

// Initialisation
window.onload = ()=>{
  loadJobs();
  startScrapeCountdown();
};
</script>

</body>
</html>
